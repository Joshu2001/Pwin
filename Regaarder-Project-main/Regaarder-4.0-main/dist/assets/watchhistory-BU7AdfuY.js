const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/home-CbFSLjTq.js","assets/index-CDLvsHig.js","assets/vendor-Cml8jNaD.js","assets/index-CLKSAEKd.css","assets/Videoplayer-rz69fR10.js","assets/media-6x2eImMv.js","assets/config-DzyQUiLS.js","assets/star-CZ5tILF0.js","assets/trending-up-CuOwQEP6.js","assets/clock-DPoV4f73.js","assets/globe-BZlhb9gl.js","assets/book-open-BM4peoPL.js","assets/video-PCYUDQnf.js","assets/StaffLoginModal-CZ_TrLDT.js","assets/alert-circle-DDjw3v1i.js","assets/SharedBottomBar-BtH9XXpB.js","assets/home-DAn91k--.js","assets/pencil-BXuq6jQD.js","assets/x-DDjMse-C.js","assets/dollar-sign-DpwwbGFC.js","assets/sparkles-fOZQJ2em.js","assets/share-2-BhBKJRU6.js","assets/alert-triangle-DDTO-rMn.js","assets/thumbs-down-B0cxNFGl.js","assets/chevron-right-D5WctnHP.js","assets/chevron-left-Cck2l4gk.js","assets/chevron-down-dLGymyOb.js","assets/pin-D3K4G80p.js","assets/bookmark-Cxynj0ML.js","assets/crown-DVmf_WXw.js","assets/camera-CWkdHYVM.js","assets/zap-C42hq4J7.js","assets/list-plus-oI1lK-_S.js","assets/folder-D-VwH1vE.js","assets/users-BiCMxHCp.js","assets/shield-ltjYLtvq.js","assets/history-CWEqLk83.js","assets/gift-DtMPeLUS.js","assets/credit-card-CWhhJIQz.js","assets/user-Cdn9UcxC.js","assets/message-square-1Q_4_xQK.js","assets/heart-off-Cosnr8m5.js","assets/heart-DB4xlq4_.js","assets/more-vertical-WN9ATN4m.js","assets/lightbulb-DqbS_5Vq.js","assets/trophy-BFJ577G0.js","assets/search-0IVNTpOf.js","assets/settings-C8dknN7h.js","assets/bell--Mm29GYl.js"])))=>i.map(i=>d[i]);
import{j as t,g as e,_ as r}from"./index-CDLvsHig.js";import{d as a,e as o}from"./vendor-Cml8jNaD.js";import{W as s}from"./config-DzyQUiLS.js";import{S as n}from"./SharedBottomBar-BtH9XXpB.js";import{C as i}from"./chevron-left-Cck2l4gk.js";import{S as c}from"./search-0IVNTpOf.js";import{M as l}from"./pencil-BXuq6jQD.js";import{H as d}from"./history-CWEqLk83.js";import{L as h}from"./lightbulb-DqbS_5Vq.js";import{C as m}from"./check-circle-DYQuHbjP.js";import"./home-DAn91k--.js";const u="undefined"!=typeof window&&localStorage.getItem("regaarder_language")||"English",w=t=>e(t,u),p="watchHistory";let g=null;const x=()=>{try{if("undefined"==typeof window||!window.localStorage)return g||[];const t=window.localStorage.getItem(p);return t?JSON.parse(t):[]}catch(t){try{return g||[]}catch(e){return[]}}},f=t=>{try{if("undefined"==typeof window||!window.localStorage){g=t;try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}return}window.localStorage.setItem(p,JSON.stringify(t));try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}catch(e){g=t;try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}};function y(t={}){try{const{videoId:e,userId:r=null,lastWatchedTime:a=0,duration:o=0,isComplete:s=!1}=t,n=t.timestamp?"string"==typeof t.timestamp?t.timestamp:new Date(t.timestamp).toISOString():(new Date).toISOString();if(!e)return!1;const i=x(),c=i.findIndex(t=>String(t.videoId)===String(e)),l={videoId:e,userId:r,lastWatchedTime:Number(a)||0,duration:Number(o)||0,timestamp:n,isComplete:Boolean(s)};c>=0?i[c]={...i[c],...l}:i.unshift(l),i.length>200&&i.splice(200),f(i);try{const t=window&&window.__BACKEND_URL__||"https://pwin.onrender.com",e=localStorage.getItem("regaarder_token");fetch(`${t}/watch/history`,{method:"POST",headers:{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}},body:JSON.stringify(l)}).then(()=>{try{window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}).catch(()=>{});try{const r={videoId:l.videoId,currentTime:Math.floor(l.lastWatchedTime||0),anonId:localStorage.getItem("playback_anon")};fetch(`${t}/api/playback`,{method:"POST",headers:{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}},body:JSON.stringify(r)}).catch(()=>{})}catch{}}catch{}return!0}catch(e){return console.warn("recordWatchProgress failed",e),!1}}function v(){try{const t=window&&window.__BACKEND_URL__||"https://pwin.onrender.com",e=localStorage.getItem("regaarder_token");window.fetch;return window.fetch?(window.fetch(`${t}/watch/history`,{headers:e?{Authorization:`Bearer ${e}`}:{}}).then(t=>t.json()).then(t=>{t&&Array.isArray(t.history)&&f(t.history)}).catch(()=>{}),x()):x()}catch{return x()}}function S(){try{"undefined"!=typeof window&&window.localStorage&&window.localStorage.removeItem(p),g=null;try{const t=window&&window.__BACKEND_URL__||"https://pwin.onrender.com",e=localStorage.getItem("regaarder_token");window.fetch&&window.fetch(`${t}/watch/history`,{method:"DELETE",headers:e?{Authorization:`Bearer ${e}`}:{}}).catch(()=>{})}catch{}}catch(t){g=null}}const j=()=>{const e=a(),[p,g]=o.useState("Requests"),[x,y]=o.useState(!1),[j,b]=o.useState(()=>v());o.useEffect(()=>{const t=()=>{try{b(v())}catch{}};try{window.addEventListener("watchhistory:updated",t)}catch{}const e=setInterval(t,5e3);return()=>{try{window.removeEventListener("watchhistory:updated",t)}catch{}clearInterval(e)}},[]);const[N,$]=o.useState({}),[I,T]=o.useState("");o.useEffect(()=>{(async()=>{try{const t=window&&window.__BACKEND_URL__||"https://pwin.onrender.com",e=await fetch(`${t}/videos`).then(t=>t.json()).catch(()=>null),r=e&&e.success&&Array.isArray(e.videos)?e.videos:[],a={};r.forEach(t=>{t.id&&(a[`id:${String(t.id)}`]=t),t.videoUrl&&(a[`url:${String(t.videoUrl)}`]=t),t.url&&(a[`url:${String(t.url)}`]=t),t.src&&(a[`url:${String(t.src)}`]=t),t.title&&(a[`title:${String(t.title)}`]=t)}),$(a)}catch{}})()},[j.length]);const C=t=>{try{return N[`id:${String(t.videoId)}`]||N[`url:${String(t.videoId)}`]||null}catch{return null}},_=async t=>{try{const e=C(t)||{},r=await A(t.videoId)||t.videoId,a=r?((t,e=0)=>{try{const r=Math.max(0,Math.floor(e||0));let a=null,o=null;return t&&"object"==typeof t?(a=t.id||t.videoId||null,o=t.url||t.videoUrl||t.src||null):o=t||null,a?`${s}/share/video/${encodeURIComponent(a)}${r?`?t=${encodeURIComponent(r)}`:""}`:o?`${s}/videoplayer?src=${encodeURIComponent(o)}${r?`&t=${encodeURIComponent(r)}`:""}`:s}catch{return s}})({id:e.id,url:r},t.lastWatchedTime):window.location.href,o=e.title||"Watch this video",n=`${o}${e.author?` • by ${e.author}`:""}`;navigator.share?await navigator.share({title:o,text:n,url:a}):(await(navigator.clipboard&&navigator.clipboard.writeText(a)),alert("Share link copied"))}catch(e){console.warn("share failed",e)}},E=t=>{try{const e=Math.max(0,Math.floor(Number(t)||0)),r=Math.floor(e/60);return`${r}:${String(e%60).padStart(2,"0")}`}catch{return"0:00"}},A=async t=>{try{if("string"==typeof t&&/^(https?:)?\/\//.test(t))return t;const e=await r(()=>import("./home-CbFSLjTq.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48])),a=e.getVideoById,o=e.VIDEOS||e.default?.VIDEOS||e.homeVideos||e.discoverItems||null;let s=null;"function"==typeof a&&(s=a(t)),!s&&Array.isArray(o)&&(s=o.find(e=>String(e.id)===String(t)));return s?.url||s?.videoUrl||s?.src||null||null}catch(e){return null}};return t.jsxs("div",{className:"flex justify-center min-h-screen w-full bg-white relative",children:[t.jsxs("div",{className:"w-full flex flex-col bg-white overflow-x-hidden",children:[t.jsx("header",{className:"bg-white border-b border-gray-100 p-4 sticky top-0 z-20",style:{paddingTop:"calc(16px + env(safe-area-inset-top, 0px))"},children:t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx(i,{className:"w-6 h-6 text-gray-700 cursor-pointer transition hover:text-gray-900",onClick:()=>{try{"undefined"!=typeof window&&"function"==typeof window.setFooterTab&&window.setFooterTab("home")}catch(t){}try{e("/home",{replace:!0})}catch(t){}}}),t.jsx("h1",{className:"text-xl font-semibold text-gray-800",children:w("Watch History")})]})}),t.jsxs("div",{className:"p-4 space-y-3 border-b border-gray-100",children:[t.jsx("button",{onClick:()=>{try{S()}catch{}b([]),y(!0),setTimeout(()=>{y(!1)},3e3)},className:"text-sm font-medium hover:opacity-80 transition duration-150",style:{color:"#FFFFFF",backgroundColor:"var(--color-gold)",padding:"6px 12px",borderRadius:"6px"},children:w("Clear All")}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center bg-gray-50 border border-gray-200 rounded-md px-2 py-2 w-full max-w-md",children:[t.jsx(c,{className:"w-4 h-4 text-gray-500"}),t.jsx("input",{value:I,onChange:t=>T(t.target.value),placeholder:w("Search"),className:"bg-transparent outline-none text-sm ml-2 w-full"})]}),t.jsxs("p",{className:"text-sm text-gray-500 ml-4 whitespace-nowrap",children:[(j||[]).length," ",w("videos")]})]})]}),t.jsxs("main",{className:"flex-grow flex flex-col items-center justify-start p-6 space-y-6",style:{paddingBottom:"calc(60px + env(safe-area-inset-bottom))"},children:[j&&j.length>0?t.jsx("div",{className:"w-full space-y-4",children:Object.entries(j.reduce((t,e)=>{const r=new Date(e.timestamp),a=r.toLocaleDateString("en-US",{weekday:"long"}),o=w(a),s=`${a}-${r.getFullYear()}-${r.getMonth()+1}-${r.getDate()}`;return(t[s]=t[s]||{label:o,date:r,items:[]}).items.push(e),t},{})).sort((t,e)=>e[1].date-t[1].date).map(([e,r])=>t.jsxs("div",{className:"w-full",children:[t.jsx("div",{className:"text-sm font-semibold text-gray-700 mb-2",children:r.label}),r.items.filter(t=>{const e=C(t)||{},r=e.title||String(t.videoId),a=e.author||"",o=e.requester||"",s=I.trim().toLowerCase();return!s||r.toLowerCase().includes(s)||a.toLowerCase().includes(s)||o.toLowerCase().includes(s)}).map(e=>{const r=C(e)||{},a=r.imageUrl||"https://placehold.co/160x90/efefef/777?text=Video",o=r.title||String(e.videoId),s=r.author||"",n=r.requester||"",i=(t=>{try{const e=Number(t.views||0),r=Number(t.comments||0),a=Number(t.shares||0),o=Math.max(e,r,a);return o===e&&e>0?`${e} ${w("views")}`:o===r&&r>0?`${r} ${w("comments")}`:o===a&&a>0?`${a} ${w("shares")}`:null}catch{return null}})(r);return t.jsxs("div",{className:"w-full bg-white rounded-xl shadow-sm border border-gray-100 p-2 flex items-center space-x-3 select-none",onClick:async()=>{try{const t=await A(e.videoId)||e.videoId;t&&(window.location.href=`/videoplayer?video=${encodeURIComponent(t)}&t=${Math.floor(e.lastWatchedTime||0)}`)}catch{}},onTouchStart:t=>{t.currentTarget.dataset.startX=t.touches[0].clientX},onTouchMove:t=>{const e=parseFloat(t.currentTarget.dataset.startX||"0"),r=t.touches[0].clientX-e;t.currentTarget.style.transform=`translateX(${r}px)`},onTouchEnd:t=>{const r=parseFloat(t.currentTarget.dataset.startX||"0"),a=t.changedTouches[0].clientX-r;t.currentTarget.style.transform="",a<-80&&(t=>{try{const e=(j||[]).filter(e=>String(e.videoId)!==String(t));b(e),f(e);try{const e=window&&window.__BACKEND_URL__||"https://pwin.onrender.com",r=localStorage.getItem("regaarder_token");window.fetch&&window.fetch(`${e}/watch/history/${encodeURIComponent(t)}`,{method:"DELETE",headers:r?{Authorization:`Bearer ${r}`}:{}}).catch(()=>{})}catch{}}catch{}})(e.videoId),t.currentTarget.dataset.startX="0"},children:[t.jsx("img",{src:a,alt:o,className:"w-40 h-24 object-cover rounded-md",onError:t=>{t.currentTarget.src="https://placehold.co/160x90/efefef/777?text=Video"}}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm font-medium text-gray-900 line-clamp-2",children:o}),t.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:[s,s&&n?" • ":"",n]}),t.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:[w("Left at")," ",E(e.lastWatchedTime)," • ",new Date(e.timestamp).toLocaleString()]}),i&&t.jsx("div",{className:"text-xs text-gray-600 mt-0.5",children:i})]}),t.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900","aria-label":"Share",onClick:t=>{t.stopPropagation(),_(e)},children:t.jsx(l,{className:"w-5 h-5"})})]},`${e.videoId}-${e.timestamp}`)})]},e))}):t.jsxs("div",{className:"flex-grow flex flex-col items-center justify-center text-center space-y-4 pt-8",children:[t.jsx(d,{className:"w-16 h-16 text-gray-400",strokeWidth:1}),t.jsx("h2",{className:"text-lg font-semibold text-gray-700",children:w("No watch history")}),t.jsx("p",{className:"text-sm text-gray-500 max-w-xs",children:w("Videos you watch will appear here")})]}),t.jsxs("div",{className:"w-full px-4 py-3 bg-[#F5F5DC] text-gray-700 rounded-xl flex items-start space-x-2",style:{borderColor:"var(--color-gold-light)",borderStyle:"solid",boxShadow:"0 6px 16px rgba(var(--color-gold-rgb,203,138,0),0.06)"},children:[t.jsx(h,{className:"w-4 h-4 mt-0.5 text-[var(--color-gold)] flex-shrink-0"}),t.jsx("p",{className:"text-xs leading-relaxed font-medium",children:w("Swipe right to request similar video • Swipe left to delete")})]})]}),t.jsx(n,{selectedLanguage:u}),x&&t.jsx("div",{className:"fixed left-0 right-0 flex justify-center z-50",style:{top:"calc(12px + env(safe-area-inset-top, 0px))"},onTouchStart:t=>{t.currentTarget.dataset.dragStartX=t.touches[0].clientX},onTouchMove:t=>{const e=parseFloat(t.currentTarget.dataset.dragStartX||"0"),r=t.touches[0].clientX-e,a=t.currentTarget.querySelector("div");a&&(a.style.transform=`translateX(${r}px)`)},onTouchEnd:t=>{const e=parseFloat(t.currentTarget.dataset.dragStartX||"0"),r=t.changedTouches[0].clientX-e,a=t.currentTarget.querySelector("div");Math.abs(r)>80?y(!1):a&&(a.style.transform="translateX(0)"),t.currentTarget.dataset.dragStartX="0"},children:t.jsxs("div",{className:"bg-white p-3 mx-4 rounded-xl shadow-2xl flex items-center space-x-3 transition-all duration-300 max-w-sm w-full cursor-grab select-none",style:{borderLeft:"4px solid #4CAF50",animation:"toastSlideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1)"},children:[t.jsx(m,{className:"w-6 h-6 text-[#4CAF50] fill-[#4CAF50]/10",strokeWidth:2}),t.jsx("span",{className:"text-base font-medium text-gray-800",children:w("Watch history cleared")})]})})]}),t.jsx("style",{children:"\n        @keyframes toastSlideDown {\n          from {\n            opacity: 0;\n            transform: translateY(-20px) scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n          }\n        }\n      "})]})};export{S as clearWatchHistory,j as default,v as getWatchHistory,y as recordWatchProgress};
